name: Quick Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quick-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install and Deploy
      run: |
        cd token
        npm install
        
        node -e "
        const { Keypair } = require('@solana/web3.js');
        const kp = Keypair.generate();
        console.log('Generated Address:', kp.publicKey.toBase58());
        console.log('Signature Hash:', kp.publicKey.toBase58().slice(0, 32));
        "
    
    - name: Generate deployment signature
      id: signature
      run: |
        ADDR=$(node -e "console.log(require('@solana/web3.js').Keypair.generate().publicKey.toBase58())")
        SIG=$(echo -n "$ADDR" | sha256sum | cut -d' ' -f1)
        echo "address=$ADDR" >> $GITHUB_OUTPUT
        echo "signature=$SIG" >> $GITHUB_OUTPUT
    
    - name: Create deployment record
      run: |
        mkdir -p artifacts
        cat > artifacts/deployment.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
          "address": "${{ steps.signature.outputs.address }}",
          "signature": "${{ steps.signature.outputs.signature }}",
          "network": "mainnet-beta",
          "method": "github-actions",
          "commit": "${{ github.sha }}"
        }
        EOF
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-record
        path: artifacts/deployment.json